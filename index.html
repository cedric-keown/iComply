<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>iComply - Broker Portal</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Phoenix Theme CSS -->
    <link href="https://prium.github.io/phoenix/v1.23.0/assets/css/phoenix.min.css" rel="stylesheet">
    <link href="https://prium.github.io/phoenix/v1.23.0/assets/css/theme.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link href="css/main.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #5CBDB4;
            --text-color: #4A4A4A;
            --bg-color: #FFFFFF;
            --light-grey: #F8F9FA;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --info: #17A2B8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background-color: var(--light-grey);
            padding-top: 70px;
        }

        /* Top Navigation Bar */
        .top-navbar {
            background: var(--bg-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 70px;
            z-index: 1030;
        }

        .navbar-brand {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .navbar-brand:hover {
            color: var(--primary-color);
        }

        .global-search {
            flex: 1;
            max-width: 500px;
            margin: 0 20px;
            position: relative;
        }

        .global-search input {
            width: 100%;
            padding: 8px 40px 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .global-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(92, 189, 180, 0.25);
        }

        .global-search i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .action-button {
            position: relative;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-button:hover {
            background-color: var(--light-grey);
        }

        .action-button .badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            min-width: 18px;
            text-align: center;
        }

        .user-menu-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            position: relative;
        }

        .user-menu-dropdown:hover {
            background-color: var(--light-grey);
        }

        /* Ensure user dropdown menu opens on the right */
        .navbar-actions .dropdown {
            position: relative;
        }

        .navbar-actions .dropdown-menu.dropdown-menu-end {
            right: 0 !important;
            left: auto !important;
            margin-top: 8px;
        }

        .avatar-sm {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 70px;
            left: 0;
            height: calc(100vh - 70px);
            width: 260px;
            background: var(--bg-color);
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, width 0.3s ease;
            overflow-y: auto;
            z-index: 1020;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .sidebar-menu-item:hover {
            background-color: var(--light-grey);
        }

        .sidebar-menu-item.active {
            background-color: rgba(92, 189, 180, 0.1);
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }

        .sidebar-menu-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .sidebar-menu-item span {
            display: none;
        }

        .sidebar.collapsed .sidebar-menu-item {
            justify-content: center;
        }

        .menu-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: 70px;
        }

        /* Breadcrumbs */
        .breadcrumb-nav {
            background: var(--bg-color);
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
            border-bottom: 1px solid #dee2e6;
        }

        .breadcrumb {
            margin: 0;
            background: none;
        }

        /* Dashboard Cards */
        .stat-card {
            background: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 100%;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 10px 0;
        }

        .stat-card .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-icon {
            font-size: 2.5rem;
            opacity: 0.3;
            float: right;
        }

        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background: var(--light-grey);
            margin: 15px 0;
        }

        .progress-bar-custom .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4a9d96 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .hero-section h2 {
            margin: 0 0 10px 0;
            font-size: 1.75rem;
        }

        .hero-section p {
            margin: 0;
            opacity: 0.9;
        }

        /* Tables */
        .data-table {
            background: var(--bg-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table table {
            margin: 0;
        }

        .data-table thead {
            background: var(--light-grey);
        }

        .data-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 15px;
        }

        .data-table td {
            padding: 15px;
            vertical-align: middle;
        }

        /* Alerts List */
        .alert-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-item.critical {
            border-left: 4px solid var(--danger);
        }

        .alert-item.high {
            border-left: 4px solid #ff9800;
        }

        .alert-item.medium {
            border-left: 4px solid var(--warning);
        }

        /* Mobile */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .global-search {
                display: none;
            }
        }

        /* Dropdowns */
        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 10px 0;
        }

        .dropdown-item {
            padding: 10px 20px;
        }

        .dropdown-item:hover {
            background-color: var(--light-grey);
        }

        .dropdown-divider {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light top-navbar fixed-top">
        <div class="container-fluid">
            <!-- Left side -->
            <button class="btn btn-link d-lg-none me-2" id="sidebarToggleMobile" type="button">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand" href="#" onclick="goToDashboard()">
                <i class="fas fa-shield-alt me-2"></i>
                <span class="d-none d-md-inline">iComply</span>
            </a>
            
            <!-- Center - Global Search -->
            <div class="global-search d-none d-lg-block">
                <input type="search" id="globalSearch" placeholder="Search representatives, clients, documents... (Ctrl+K)" autocomplete="off">
                <i class="fas fa-search"></i>
            </div>
            
            <!-- Right side -->
            <div class="navbar-actions">
                <button class="action-button" id="alertsButton" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-bell"></i>
                    <span class="badge">12</span>
            </button>
                <ul class="dropdown-menu dropdown-menu-end" style="width: 350px; max-height: 400px; overflow-y: auto;">
                    <li class="dropdown-header d-flex justify-content-between align-items-center">
                        <span>Alerts & Notifications</span>
                        <button class="btn btn-sm btn-link p-0">Mark All</button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <div class="alert-item critical">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>üî¥ CRITICAL</strong>
                                    <p class="mb-1 small">Mike Johnson's RE5 expired 2 days ago</p>
                                    <small class="text-muted">2h ago</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary">View</button>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="alert-item high">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>üü† HIGH PRIORITY</strong>
                                    <p class="mb-1 small">45 FICA reviews overdue</p>
                                    <small class="text-muted">3h ago</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary">View</button>
                            </div>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-center" href="#">View All Alerts</a></li>
                </ul>
                
                <button class="action-button" id="helpButton" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-question-circle"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li class="dropdown-header">Help & Support</li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-book me-2"></i>Documentation</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-video me-2"></i>Video Tutorials</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-phone me-2"></i>Contact Support</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-star me-2"></i>What's New</a></li>
                </ul>

                <div class="dropdown">
                    <div class="user-menu-dropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="avatar-sm">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="d-none d-md-inline user-name">Loading...</span>
                        <i class="fas fa-chevron-down d-none d-md-inline"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end" style="width: 280px;">
                        <li class="dropdown-header">
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2" style="width: 40px; height: 40px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">Loading...</div>
                                    <small class="text-muted">User</small>
                                </div>
                            </div>
                        </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>My Profile</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-lock me-2"></i>Change Password</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Preferences</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-moon me-2"></i>Dark Mode</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
                </div>
            </div>
        </div>
    </nav>

            <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header d-none d-lg-flex justify-content-between align-items-center">
            <small class="text-muted" id="currentDate"></small>
            <button class="btn btn-sm btn-link" id="sidebarToggle" type="button">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a class="sidebar-menu-item active" href="#" data-route="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                                </a>
                            </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="representatives">
                    <i class="fas fa-users"></i>
                    <span>Representatives</span>
                    <span class="menu-badge">15</span>
                                </a>
                            </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="cpd">
                    <i class="fas fa-graduation-cap"></i>
                    <span>CPD Management</span>
                    <span class="menu-badge">5</span>
                            </a>
                        </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="clients">
                    <i class="fas fa-building"></i>
                    <span>Clients & FICA</span>
                    <span class="menu-badge">13</span>
                            </a>
                        </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="documents">
                    <i class="fas fa-folder-open"></i>
                    <span>Documents</span>
                    <span class="menu-badge">12</span>
                </a>
            </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="fit-proper">
                    <i class="fas fa-user-check"></i>
                    <span>Fit & Proper</span>
                    <span class="menu-badge">2</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="compliance">
                    <i class="fas fa-shield-alt"></i>
                    <span>Compliance</span>
                    <span class="menu-badge">4</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="complaints">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Complaints</span>
                    <span class="menu-badge">2</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="alerts">
                    <i class="fas fa-bell"></i>
                    <span>Alerts & Notifications</span>
                    <span class="menu-badge">17</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="audits">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Internal Audits</span>
                    <span class="menu-badge">1</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports & Analytics</span>
                                        </a>
                                    </li>
            <li>
                <a class="sidebar-menu-item" href="#" data-route="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings & Administration</span>
                                        </a>
                                    </li>
                    </ul>
        <div class="p-3 border-top mt-auto">
            <div class="fw-bold small mb-2">QUICK ACTIONS</div>
                    <button class="btn btn-primary btn-sm w-100 mb-2" onclick="handleQuickAction('add-representative')">
                        <i class="fas fa-plus me-1"></i>Add Representative
                    </button>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="handleQuickAction('upload-document')">
                        <i class="fas fa-upload me-1"></i>Upload Document
                    </button>
                </div>
            </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Breadcrumbs -->
        <nav class="breadcrumb-nav" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i> Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
            </ol>
        </nav>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Hero Section - License Status Card -->
            <div class="hero-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2><i class="fas fa-check-circle me-2"></i>FSP LICENSE ACTIVE</h2>
                        <p class="mb-2">Loading FSP Information...</p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <small>License Valid Until: <strong>31/12/2025</strong> (377 days)</small><br>
                                <small>Next Renewal: <strong>October 2025</strong></small>
                                </div>
                            <div class="col-md-6">
                                <small>Professional Indemnity: <strong>‚úÖ Valid</strong></small><br>
                                <small>Fidelity: <strong>‚úÖ Valid</strong></small>
                                </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light me-2">View License</button>
                        <button class="btn btn-light">Renewal Checklist</button>
                            </div>
                        </div>
                    </div>

            <!-- Row 1: Key Performance Indicators -->
            <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-label">Compliance Health</div>
                        <div class="stat-value">87%</div>
                        <div class="progress-bar-custom">
                            <div class="progress-fill" style="width: 87%"></div>
                                        </div>
                        <div class="mt-3">
                            <small>‚úÖ 12/15 Reps</small><br>
                            <small>‚ö†Ô∏è 3 Action Required</small>
                                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2">View Details</button>
                        <i class="fas fa-shield-alt stat-icon text-primary"></i>
                                    </div>
                                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-label">Monthly Revenue</div>
                        <div class="stat-value">R 456,890</div>
                        <div class="mt-2">
                            <small class="text-success">‚Üë 12% vs last month</small>
                            </div>
                        <div class="mt-3">
                            <small>YTD: <strong>R 4.2M</strong></small><br>
                            <small>Target: <strong>R 5.5M</strong></small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2">View Reports</button>
                        <i class="fas fa-chart-line stat-icon text-success"></i>
                    </div>
                </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-label">Active Clients</div>
                        <div class="stat-value">248</div>
                        <div class="mt-2">
                            <small class="text-success">‚Üë 8 new this month</small>
                                        </div>
                        <div class="mt-3">
                            <small>235 FICA Compliant</small><br>
                            <small>13 Pending</small>
                                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2">View Clients</button>
                        <i class="fas fa-users stat-icon text-info"></i>
                                    </div>
                                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="stat-label">Team Performance</div>
                        <div class="stat-value">4.2/5.0</div>
                        <div class="mt-2">
                            <small>‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ</small>
                        </div>
                        <div class="mt-3">
                            <small>Top: Sarah N. (4.8)</small><br>
                            <small>CPD: 89% Complete</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2">View Team</button>
                        <i class="fas fa-star stat-icon text-warning"></i>
                    </div>
                            </div>
                        </div>

            <!-- Row 2: Team Compliance Matrix -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="data-table">
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <h5 class="mb-0">Team Compliance Matrix</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2">Export</button>
                                <button class="btn btn-sm btn-outline-secondary">Print</button>
                                        </div>
                                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Representative</th>
                                        <th>F&P</th>
                                        <th>CPD</th>
                                        <th>FICA</th>
                                        <th>Docs</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Sarah Naidoo</strong></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td>18/18</td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-success">Compliant</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Thabo Mokoena</strong></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td>14/18</td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-warning">In Progress</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Mike Khumalo</strong></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td>3/18</td>
                                        <td><span class="badge bg-warning">‚ö†Ô∏è</span></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-danger">Non-Compliant</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Johan van Zyl</strong></td>
                                        <td><span class="badge bg-warning">‚ö†Ô∏è</span></td>
                                        <td>16/18</td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-success">‚úÖ</span></td>
                                        <td><span class="badge bg-warning">Action Req</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-3 border-top">
                            <button class="btn btn-sm btn-primary me-2">View Full Matrix</button>
                            <button class="btn btn-sm btn-outline-primary me-2">Send Reminders</button>
                            <button class="btn btn-sm btn-outline-secondary">Export Report</button>
                                    </div>
                                </div>
                            </div>
                        </div>

            <!-- Row 3: Critical Alerts & Upcoming Deadlines -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">üö® CRITICAL ALERTS</h5>
                            <span class="badge bg-danger">5</span>
                                        </div>
                        <div class="alert-item critical">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>üî¥ Mike Khumalo</strong>
                                    <p class="mb-1 small">RE5 expired 2 days ago</p>
                                        </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1">View</button>
                                    <button class="btn btn-sm btn-outline-secondary">Alert</button>
                                    </div>
                                </div>
                            </div>
                        <div class="alert-item high">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>üü† Sarah Miller</strong>
                                    <p class="mb-1 small">RE5 expires in 30 days</p>
                        </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1">View</button>
                                    <button class="btn btn-sm btn-outline-secondary">Schedule</button>
                    </div>
                </div>
                        </div>
                        <div class="alert-item high">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>üü† FICA Reviews</strong>
                                    <p class="mb-1 small">45 reviews overdue</p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1">View</button>
                                    <button class="btn btn-sm btn-outline-secondary">Assign</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-link w-100 mt-2">View All Alerts (12)</button>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">üìÖ UPCOMING DEADLINES</h5>
                        </div>
                        <div class="mb-3">
                            <strong>CPD Deadline</strong>
                            <p class="mb-1 small">31 May 2025 (166 days)</p>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: 89%"></div>
                            </div>
                            <small>Progress: 89% complete</small>
                            <button class="btn btn-sm btn-outline-primary d-block mt-2">View Team CPD</button>
                        </div>
                        <div class="mb-3">
                            <strong>FICA Reviews</strong>
                            <p class="mb-1 small">15 reviews next 30 days</p>
                            <button class="btn btn-sm btn-outline-primary">View Schedule</button>
                        </div>
                        <div class="mb-3">
                            <strong>Insurance Renewals</strong>
                            <p class="mb-1 small">PI: 31 Mar 2025 (107 days)</p>
                            <p class="mb-1 small">Fidelity: 30 Apr 2025</p>
                            <button class="btn btn-sm btn-outline-primary">View Policies</button>
                        </div>
                        <div>
                            <strong>FSCA Submission</strong>
                            <p class="mb-1 small">Annual Return: 31 Jan 2025</p>
                            <button class="btn btn-sm btn-outline-primary">Start Preparation</button>
                        </div>
                    </div>
        </div>
    </div>

            <!-- Row 4: Recent Activity & Quick Actions -->
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="stat-card">
                        <h5 class="mb-3">RECENT ACTIVITY</h5>
                        <div class="mb-3">
                            <small class="text-muted">2h ago</small>
                            <p class="mb-1">‚úÖ Sarah Naidoo verified client FICA: Thabo Mokoena</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">3h ago</small>
                            <p class="mb-1">üì§ Mike Khumalo uploaded CPD - 2 hours ethics training</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">5h ago</small>
                            <p class="mb-1">‚ö†Ô∏è System alert sent - RE5 expiry reminder (3 reps)</p>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">1d ago</small>
                            <p class="mb-1">üìù New complaint logged - Client: John Smith (#2024-08)</p>
                        </div>
                        <button class="btn btn-sm btn-link w-100">View All Activity</button>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="stat-card">
                        <h5 class="mb-3">QUICK ACTIONS</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-plus me-2"></i>Add Representative
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-user-plus me-2"></i>Add Client
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-upload me-2"></i>Upload Documents
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-chart-bar me-2"></i>Generate Report
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-envelope me-2"></i>Send Team Message
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-calendar me-2"></i>Schedule Audit
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-dollar-sign me-2"></i>View Financials
                            </button>
                            <button class="btn btn-outline-primary text-start">
                                <i class="fas fa-cog me-2"></i>System Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://prium.github.io/phoenix/v1.23.0/assets/js/phoenix.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Auth Service -->
    <script src="js/auth-service.js"></script>
    <!-- Data Functions -->
    <script src="js/data-functions.js"></script>
    <script src="js/navbar-badges.js"></script>

    <script>
        // Navigation State
        const navigationState = {
            currentUser: {
                id: null,
                name: 'Loading...',
                role: 'User',
                fsp: 'CustomApp Financial Services',
                fspNumber: 'FSP12345',
                email: null,
                first_name: null,
                last_name: null,
                role_name: null
            },
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true',
            activeMenuItem: 'dashboard',
            originalDashboardContent: null // Store original dashboard HTML
        };

        // Load User Profile from Database
        async function loadUserProfile() {
            try {
                // Get user info from localStorage
                const userInfoStr = localStorage.getItem('user_info');
                if (!userInfoStr) {
                    console.warn('No user info in localStorage');
                    return;
                }

                const userInfo = JSON.parse(userInfoStr);
                console.log('User info from localStorage:', userInfo);

                // Update navigation state with basic info
                navigationState.currentUser.id = userInfo.id;
                navigationState.currentUser.email = userInfo.email;

                // Fetch full user profile from database
                const response = await dataFunctions.getUserProfiles('active');
                console.log('User profiles response:', response);

                // Handle different response formats
                let profiles = [];
                if (response && response.get_user_profiles) {
                    profiles = response.get_user_profiles;
                } else if (Array.isArray(response)) {
                    profiles = response;
                }

                // Find current user's profile
                const currentUserProfile = profiles.find(p => p.id === userInfo.id || p.email === userInfo.email);
                
                if (currentUserProfile) {
                    console.log('Found user profile:', currentUserProfile);
                    
                    // Update navigation state with full profile
                    navigationState.currentUser.first_name = currentUserProfile.first_name;
                    navigationState.currentUser.last_name = currentUserProfile.last_name;
                    navigationState.currentUser.name = `${currentUserProfile.first_name} ${currentUserProfile.last_name}`;
                    navigationState.currentUser.role_name = currentUserProfile.role_name || userInfo.role_name || 'User';
                    navigationState.currentUser.job_title = currentUserProfile.job_title;
                    navigationState.currentUser.department = currentUserProfile.department;
                    
                    // Update UI elements
                    updateUserUI();
                } else {
                    console.warn('User profile not found in database, using localStorage data');
                    // Fallback to localStorage data
                    navigationState.currentUser.first_name = userInfo.first_name || 'User';
                    navigationState.currentUser.last_name = userInfo.last_name || '';
                    navigationState.currentUser.name = userInfo.first_name ? 
                        `${userInfo.first_name} ${userInfo.last_name || ''}`.trim() : 
                        userInfo.email;
                    navigationState.currentUser.role_name = userInfo.role_name || 'User';
                    updateUserUI();
                }

            } catch (error) {
                console.error('Error loading user profile:', error);
                
                // Handle RBAC permission denied errors
                if (error.code === 'RBAC_PERMISSION_DENIED') {
                    console.warn('RBAC permission denied for user profile:', error);
                    authService.showRBACError(error);
                    // Still try to use localStorage data as fallback
                }
                
                // Fallback to localStorage data
                try {
                    const userInfo = JSON.parse(localStorage.getItem('user_info'));
                    navigationState.currentUser.name = userInfo.first_name ? 
                        `${userInfo.first_name} ${userInfo.last_name || ''}`.trim() : 
                        userInfo.email;
                    navigationState.currentUser.role_name = userInfo.role_name || 'User';
                    updateUserUI();
                } catch (e) {
                    console.error('Error parsing user info:', e);
                }
            }
        }

        // Update User UI Elements
        function updateUserUI() {
            const user = navigationState.currentUser;
            
            // Get initials for avatar
            const initials = user.first_name && user.last_name ? 
                `${user.first_name.charAt(0)}${user.last_name.charAt(0)}`.toUpperCase() : 
                user.name.charAt(0).toUpperCase();
            
            // Short name for navbar (First name + Last initial)
            const shortName = user.first_name && user.last_name ?
                `${user.first_name} ${user.last_name.charAt(0)}.` :
                user.name;
            
            // Update navbar user name
            const navbarUserName = document.querySelector('.user-name');
            if (navbarUserName) {
                navbarUserName.textContent = shortName;
            }

            // Update dropdown header name
            const dropdownUserName = document.querySelector('.dropdown-header .fw-bold');
            if (dropdownUserName) {
                dropdownUserName.textContent = user.name;
            }

            // Update dropdown header role
            const dropdownUserRole = document.querySelector('.dropdown-header .text-muted');
            if (dropdownUserRole) {
                dropdownUserRole.textContent = user.job_title || user.role_name || 'User';
            }

            // Update avatar initials (all instances)
            const avatars = document.querySelectorAll('.avatar-sm');
            avatars.forEach(avatar => {
                // Replace icon with initials
                const icon = avatar.querySelector('i');
                if (icon) {
                    avatar.innerHTML = initials;
                }
            });

            console.log('UI updated with user info:', user);
        }

        // Load FSP Configuration from Database
        async function loadFspConfiguration() {
            try {
                console.log('Loading FSP configuration...');
                const response = await dataFunctions.getFspConfiguration();
                console.log('FSP configuration response:', response);

                // Handle different response formats
                let fspConfig = null;
                if (response && response.get_fsp_configuration) {
                    // Array format
                    const configs = response.get_fsp_configuration;
                    if (configs && configs.length > 0) {
                        fspConfig = configs[0];
                    }
                } else if (Array.isArray(response) && response.length > 0) {
                    fspConfig = response[0];
                } else if (response && response.fsp_name) {
                    // Direct object format
                    fspConfig = response;
                }

                if (fspConfig) {
                    console.log('FSP configuration loaded:', fspConfig);
                    
                    // Update navigation state
                    navigationState.currentUser.fsp = fspConfig.fsp_name;
                    navigationState.currentUser.fspNumber = fspConfig.fsp_license_number;
                    
                    // Update hero section with FSP details
                    updateFspUI(fspConfig);
                } else {
                    console.warn('No FSP configuration found in database');
                }

            } catch (error) {
                console.error('Error loading FSP configuration:', error);
                
                // Handle RBAC permission denied errors
                if (error.code === 'RBAC_PERMISSION_DENIED') {
                    console.warn('RBAC permission denied for FSP configuration:', error);
                    authService.showRBACError(error);
                }
            }
        }

        // Update FSP UI Elements
        function updateFspUI(fspConfig) {
            // Update hero section FSP name and license
            const heroSection = document.querySelector('.hero-section h2');
            if (heroSection) {
                heroSection.innerHTML = `<i class="fas fa-check-circle me-2"></i>FSP LICENSE ACTIVE`;
            }

            const heroFspInfo = document.querySelector('.hero-section p.mb-2');
            if (heroFspInfo) {
                heroFspInfo.textContent = `${fspConfig.fsp_name} | FSP ${fspConfig.fsp_license_number}`;
            }

            console.log('FSP UI updated with:', fspConfig);
        }

        // Global RBAC Error Handler
        // Catches unhandled promise rejections and displays RBAC errors appropriately
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.code === 'RBAC_PERMISSION_DENIED') {
                console.error('Unhandled RBAC error:', event.reason);
                event.preventDefault(); // Prevent default error handling
                
                // Show user-friendly error message
                if (typeof authService !== 'undefined' && authService.showRBACError) {
                    authService.showRBACError(event.reason);
                } else {
                    // Fallback if authService is not available
                    const message = `Permission Denied\n\nYou do not have permission to perform this action.\n\nPlease contact your administrator if you believe this is an error.`;
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Permission Denied',
                            text: message,
                            confirmButtonColor: '#dc3545'
                        });
                    } else {
                        alert(message);
                    }
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if env=DEV is present in URL - if so, skip authentication check completely
            const urlParams = new URLSearchParams(window.location.search);
            const envParam = urlParams.get('env');
            const isDevMode = envParam === 'DEV';
            
            // DEV MODE: Skip all authentication checks and proceed directly
            if (isDevMode) {
                console.log('DEV mode enabled - skipping authentication');
                // Store original dashboard content
                const dashboardContent = document.getElementById('dashboardContent');
                if (dashboardContent && !navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                initializeNavigation();
                initializeSidebar();
                updateCurrentDate();
                setupKeyboardShortcuts();
                loadUserProfile();
                loadFspConfiguration();
                // Initialize navbar badges after a short delay to ensure dataFunctions is loaded
                setTimeout(() => {
                    if (typeof initializeNavbarBadges === 'function') {
                        initializeNavbarBadges();
                    }
                }, 1500);
                return; // Exit early, no authentication check
            }
            
            // PRODUCTION MODE: Check authentication
            // Check authentication directly from localStorage (most reliable)
            const token = localStorage.getItem('lambda_token');
            const userInfo = localStorage.getItem('user_info');
            const isAuthenticated = !!(token && userInfo);
            
            if (!isAuthenticated) {
                // Get cc parameter from localStorage or URL
                const ccParam = localStorage.getItem('client_guid') || 
                               new URLSearchParams(window.location.search).get('cc') ||
                               '9e1d961a-bfc2-469d-8526-8af75f536656';
                
                // Redirect to signin with cc parameter
                const signinUrl = `signin.html?cc=${encodeURIComponent(ccParam)}`;
                window.location.href = signinUrl;
                return;
            }

            // Store original dashboard content before any modules load
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent && !navigationState.originalDashboardContent) {
                navigationState.originalDashboardContent = dashboardContent.innerHTML;
            }

            initializeNavigation();
            initializeSidebar();
            updateCurrentDate();
            setupKeyboardShortcuts();
            
            // Load user profile and FSP configuration from database
            loadUserProfile();
            loadFspConfiguration();
            
            // Initialize navbar badges after a short delay to ensure dataFunctions is loaded
            setTimeout(() => {
                if (typeof initializeNavbarBadges === 'function') {
                    initializeNavbarBadges();
                }
            }, 1500);
        });

        // Handle Logout
        function handleLogout(event) {
            if (event) {
                event.preventDefault();
            }
            
            // Show confirmation dialog
            Swal.fire({
                title: 'Sign Out?',
                text: 'Are you sure you want to sign out?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, sign out',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear all authentication data
                    const clientGuid = localStorage.getItem('client_guid');
                    
                    localStorage.removeItem('lambda_token');
                    localStorage.removeItem('user_info');
                    
                    // Clear any session storage
                    sessionStorage.clear();
                    
                    // Use authService if available
                    if (typeof authService !== 'undefined') {
                        authService.token = null;
                        authService.userInfo = null;
                    }
                    
                    // Show success message and redirect
                    Swal.fire({
                        icon: 'success',
                        title: 'Signed Out',
                        text: 'You have been successfully signed out.',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // Redirect to signin page with client guid
                        const signinUrl = clientGuid ? `signin.html?cc=${encodeURIComponent(clientGuid)}` : 'signin.html';
                        window.location.href = signinUrl;
                    });
                }
            });
        }

        // Initialize Navigation
        function initializeNavigation() {
            // Set active menu item
            const activeItem = document.querySelector(`[data-route="${navigationState.activeMenuItem}"]`);
            if (activeItem) {
                document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                    item.classList.remove('active');
                });
                activeItem.classList.add('active');
            }

            // Menu item clicks - use event delegation for better reliability
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                console.log('Setting up sidebar navigation...');
                
                // Remove any existing click handler to prevent duplicates
                if (sidebar._clickHandler) {
                    sidebar.removeEventListener('click', sidebar._clickHandler);
                }
                
                // Create new handler
                const clickHandler = function(e) {
                    console.log('Sidebar clicked, target:', e.target);
                    
                    // Check if click is on menu item or its children
                    let menuItem = e.target.closest('.sidebar-menu-item');
                    
                    // If not found, check if target is inside a menu item
                    if (!menuItem) {
                        const parent = e.target.parentElement;
                        if (parent && parent.classList.contains('sidebar-menu-item')) {
                            menuItem = parent;
                        } else if (parent && parent.parentElement && parent.parentElement.classList.contains('sidebar-menu-item')) {
                            menuItem = parent.parentElement;
                        }
                    }
                    
                    if (menuItem) {
                        e.preventDefault();
                        e.stopPropagation();
                        const route = menuItem.getAttribute('data-route');
                        console.log('Menu item found, route:', route);
                        if (route) {
                            setActiveMenuItem(route);
                            handleRoute(route);
                        } else {
                            console.warn('Menu item clicked but no route attribute found');
                        }
                    }
                };
                
                // Store reference for future removal
                sidebar._clickHandler = clickHandler;
                sidebar.addEventListener('click', clickHandler, true); // Use capture phase
                
                console.log('Sidebar navigation setup complete');
            } else {
                console.error('Sidebar element not found!');
            }
            
            // Also add direct listeners as backup
            setTimeout(() => {
                document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const route = this.getAttribute('data-route');
                        console.log('Direct menu click, route:', route);
                        if (route) {
                            setActiveMenuItem(route);
                            handleRoute(route);
                        }
                    });
                });
            }, 100);
            
            // Check for route in URL hash on page load
            const hashChangeHandler = function() {
                const route = window.location.hash.substring(1);
                if (route) {
                    console.log('Hash changed, route:', route);
                    handleRoute(route);
                }
            };
            
            window.removeEventListener('hashchange', hashChangeHandler);
            window.addEventListener('hashchange', hashChangeHandler);
            
            // Initial hash check
            if (window.location.hash) {
                const route = window.location.hash.substring(1);
                console.log('Initial hash, route:', route);
                handleRoute(route);
            } else {
                // If no hash, load dashboard by default
                console.log('No hash found, loading dashboard...');
                const dashboardContent = document.getElementById('dashboardContent');
                const breadcrumbNav = document.querySelector('.breadcrumb-nav');
                if (dashboardContent && !dashboardContent.querySelector('iframe')) {
                    loadExecutiveDashboard(dashboardContent, breadcrumbNav);
                }
            }
        }
        

        // Initialize Sidebar
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarToggleMobile = document.getElementById('sidebarToggleMobile');
            const mainContent = document.getElementById('mainContent');

            // Restore collapsed state
            if (navigationState.sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                const icon = sidebarToggle.querySelector('i');
                if (icon) icon.classList.replace('fa-chevron-left', 'fa-chevron-right');
            }

            // Desktop toggle
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    toggleSidebar();
                });
            }

            // Mobile toggle
            if (sidebarToggleMobile) {
                sidebarToggleMobile.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                });
            }

            // Close sidebar on mobile when clicking outside
            document.addEventListener('click', function(e) {
                if (window.innerWidth < 992) {
                    if (!sidebar.contains(e.target) && !sidebarToggleMobile.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                }
            });
        }

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebarToggle').querySelector('i');
            
            sidebar.classList.toggle('collapsed');
            navigationState.sidebarCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', navigationState.sidebarCollapsed);
            
            if (icon) {
                if (navigationState.sidebarCollapsed) {
                    icon.classList.replace('fa-chevron-left', 'fa-chevron-right');
                    } else {
                    icon.classList.replace('fa-chevron-right', 'fa-chevron-left');
                }
            }
        }

        // Set Active Menu Item
        function setActiveMenuItem(itemId) {
            navigationState.activeMenuItem = itemId;
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`[data-route="${itemId}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Update Current Date
        function updateCurrentDate() {
            const dateEl = document.getElementById('currentDate');
            if (dateEl) {
                const now = new Date();
                const options = { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                dateEl.textContent = now.toLocaleDateString('en-ZA', options);
            }
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            // Global search (Ctrl+K)
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('globalSearch');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }

                // Escape to close modals
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal.show');
                    modals.forEach(modal => {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) bsModal.hide();
                    });
                }
            });

            // Global search functionality
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value;
                    if (query.length > 2) {
                        // Perform search
                        console.log('Searching for:', query);
                    }
                });
            }
        }

        // Route Handler
        function handleRoute(route) {
            console.log('=== handleRoute called with:', route, '===');
            const dashboardContent = document.getElementById('dashboardContent');
            const breadcrumbNav = document.querySelector('.breadcrumb-nav');
            
            if (!dashboardContent) {
                console.error('ERROR: dashboardContent element not found');
                return;
            }
            
            if (!route) {
                console.warn('WARNING: handleRoute called with empty route');
                return;
            }
            
            console.log('Processing route:', route);
            
            switch(route) {
                case 'cpd':
                case 'cpd-management':
                    console.log('Loading CPD module...');
                    loadCPDModule(dashboardContent, breadcrumbNav);
                    break;
                case 'documents':
                case 'document-management':
                    console.log('Loading Documents module...');
                    loadDocumentsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'fit-proper':
                case 'fit-and-proper':
                    console.log('Loading Fit & Proper module...');
                    loadFitProperModule(dashboardContent, breadcrumbNav);
                    break;
                case 'complaints':
                case 'complaints-management':
                    console.log('Loading Complaints module...');
                    loadComplaintsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'representatives':
                case 'representatives-management':
                    console.log('Loading Representatives module...');
                    loadRepresentativesModule(dashboardContent, breadcrumbNav);
                    break;
                case 'compliance':
                case 'compliance-management':
                    console.log('Loading Compliance module...');
                    loadComplianceModule(dashboardContent, breadcrumbNav);
                    break;
                case 'clients':
                case 'clients-fica':
                case 'clients-and-fica':
                case 'fica':
                    console.log('Loading Clients & FICA module...');
                    loadClientsFICAModule(dashboardContent, breadcrumbNav);
                    break;
                case 'alerts':
                case 'alerts-notifications':
                case 'notifications':
                    console.log('Loading Alerts & Notifications module...');
                    loadAlertsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'audits':
                case 'internal-audits':
                    console.log('Loading Internal Audits module...');
                    loadInternalAuditsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'reports':
                case 'reports-analytics':
                case 'analytics':
                    console.log('Loading Reports & Analytics module...');
                    loadReportsAnalyticsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'team-compliance':
                case 'team-compliance-matrix':
                case 'team-matrix':
                    console.log('Loading Team Compliance Matrix module...');
                    loadTeamComplianceModule(dashboardContent, breadcrumbNav);
                    break;
                case 'settings':
                case 'settings-administration':
                case 'administration':
                    console.log('Loading Settings & Administration module...');
                    loadSettingsModule(dashboardContent, breadcrumbNav);
                    break;
                case 'dashboard':
                case 'executive':
                case 'executive-dashboard':
                    console.log('Loading Executive Dashboard...');
                    loadExecutiveDashboard(dashboardContent, breadcrumbNav);
                    break;
                default:
                    // If route not recognized, try to restore dashboard
                    console.warn('Unknown route:', route, '- loading dashboard');
                    if (dashboardContent && !dashboardContent.querySelector('iframe')) {
                        console.log('Unknown route, loading dashboard...');
                        loadExecutiveDashboard(dashboardContent, breadcrumbNav);
                    }
                    break;
            }
            
            console.log('=== handleRoute completed for:', route, '===');
        }
        
        // Make handleRoute globally accessible for debugging
        // Quick Actions Handler
        window.handleQuickAction = function(action) {
            switch(action) {
                case 'add-representative':
                    handleRoute('representatives');
                    // Wait for module to load, then switch to Add New Representative tab
                    setTimeout(() => {
                        const iframe = document.getElementById('dashboardContent')?.querySelector('iframe');
                        if (iframe && iframe.contentWindow) {
                            try {
                                iframe.contentWindow.postMessage({ action: 'switchTab', tab: 'add-representative' }, '*');
                            } catch (e) {
                                console.warn('Could not switch tab in iframe:', e);
                            }
                        }
                    }, 1000);
                    break;
                case 'upload-document':
                    handleRoute('documents');
                    // Wait for module to load, then switch to Upload tab
                    setTimeout(() => {
                        const iframe = document.getElementById('dashboardContent')?.querySelector('iframe');
                        if (iframe && iframe.contentWindow) {
                            try {
                                iframe.contentWindow.postMessage({ action: 'switchTab', tab: 'upload' }, '*');
                            } catch (e) {
                                console.warn('Could not switch tab in iframe:', e);
                            }
                        }
                    }, 1000);
                    break;
                default:
                    console.warn('Unknown quick action:', action);
            }
        };

        window.handleRoute = handleRoute;
        window.setActiveMenuItem = setActiveMenuItem;
        
        // Load CPD Module
        function loadCPDModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">CPD Management</li>
                        </ol>
                    `;
                }
                
                // Load CPD module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/cpd/html/cpd_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="CPD Management"
                            id="cpdModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#cpd';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Documents Module
        function loadDocumentsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Document Management</li>
                        </ol>
                    `;
                }
                
                // Load Documents module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/documents/html/document_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Document Management"
                            id="documentsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#documents';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Fit & Proper Module
        function loadFitProperModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Fit & Proper Management</li>
                        </ol>
                    `;
                }
                
                // Load Fit & Proper module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/fit-and-proper/html/fit_and_proper.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Fit & Proper Management"
                            id="fitProperModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#fit-proper';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Complaints Module
        function loadComplaintsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Complaints Management</li>
                        </ol>
                    `;
                }
                
                // Load Complaints module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/complaints/html/complaints_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Complaints Management"
                            id="complaintsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#complaints';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Representatives Module
        function loadRepresentativesModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Representatives Management</li>
                        </ol>
                    `;
                }
                
                // Load Representatives module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/representatives/html/representatives_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Representatives Management"
                            id="representativesModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#representatives';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Compliance Module
        function loadComplianceModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Compliance Management</li>
                        </ol>
                    `;
                }
                
                // Load Compliance module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/compliance/html/compliance_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Compliance Management"
                            id="complianceModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#compliance';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Clients & FICA Module
        function loadClientsFICAModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Clients & FICA Management</li>
                        </ol>
                    `;
                }
                
                // Load Clients & FICA module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/clients-fica/html/clients_fica_management.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Clients & FICA Management"
                            id="clientsFicaModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#clients-fica';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Alerts & Notifications Module
        function loadAlertsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Alerts & Notifications</li>
                        </ol>
                    `;
                }
                
                // Load Alerts & Notifications module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/alerts-notifications/html/alerts_notifications.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Alerts & Notifications"
                            id="alertsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#alerts';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Internal Audits Module
        function loadInternalAuditsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Internal Audits</li>
                        </ol>
                    `;
                }
                
                // Load Internal Audits module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/internal-audits/html/internal_audits.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Internal Audits"
                            id="internalAuditsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#audits';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Reports & Analytics Module
        function loadReportsAnalyticsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Reports & Analytics</li>
                        </ol>
                    `;
                }
                
                // Load Reports & Analytics module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/reports-analytics/html/reports_analytics.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Reports & Analytics"
                            id="reportsAnalyticsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#reports';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Team Compliance Matrix Module
        function loadTeamComplianceModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Team Compliance Matrix</li>
                        </ol>
                    `;
                }
                
                // Load Team Compliance Matrix module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/team-compliance/html/team_compliance_matrix.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Team Compliance Matrix"
                            id="teamComplianceModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#team-compliance';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Settings & Administration Module
        function loadSettingsModule(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" onclick="goToDashboard(); return false;"><i class="fas fa-home"></i> Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Settings & Administration</li>
                        </ol>
                    `;
                }
                
                // Load Settings & Administration module via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/settings-administration/html/settings_administration.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Settings & Administration"
                            id="settingsModuleFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#settings';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Load Executive Dashboard
        function loadExecutiveDashboard(dashboardContent, breadcrumbNav) {
            if (dashboardContent) {
                // Store original content if not already stored
                if (!navigationState.originalDashboardContent) {
                    navigationState.originalDashboardContent = dashboardContent.innerHTML;
                }
                
                // Update breadcrumb
                if (breadcrumbNav) {
                    breadcrumbNav.innerHTML = `
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-home"></i> Executive Dashboard</li>
                        </ol>
                    `;
                }
                
                // Load Executive Dashboard via iframe
                dashboardContent.innerHTML = `
                    <iframe src="modules/executive-dashboard/html/executive_dashboard.html" 
                            style="width: 100%; height: calc(100vh - 200px); border: none; margin-top: -20px;"
                            title="Executive Dashboard"
                            id="executiveDashboardFrame"></iframe>
                `;
                
                // Update URL hash
                window.location.hash = '#dashboard';
            } else {
                console.error('Dashboard content area not found');
            }
        }
        
        // Restore Dashboard (now loads Executive Dashboard)
        function restoreDashboard(dashboardContent, breadcrumbNav) {
            loadExecutiveDashboard(dashboardContent, breadcrumbNav);
        }
        
        // Navigation Functions
        function goToDashboard() {
            console.log('goToDashboard called');
            const dashboardContent = document.getElementById('dashboardContent');
            const breadcrumbNav = document.querySelector('.breadcrumb-nav');
            restoreDashboard(dashboardContent, breadcrumbNav);
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth >= 992) {
                sidebar.classList.remove('show');
            }
        });
    </script>
</body>
</html>

